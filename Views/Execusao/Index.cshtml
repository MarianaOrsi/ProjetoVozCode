@{
    ViewData["Title"] = "Editor";
    Layout = null;
}

<div class="ide-container">

    <!-- ==== SIDEBAR ESQUERDA ==== -->
    <div class="sidebar">
        <div>
            <div class="bottom-ide">
                @* <button class="bottom-analisar" form="analisarCodigo" onclick="lerEditor()">Conferir código</button> *@
                <button class="bottom-analisar" onclick="AnalisarCodigo()">Conferir código</button>
            </div>
        </div>
        <div class="sidebar-content">
            @* feedback do código *@

            <p id="RetornoIa"></p>
        </div>
    </div>

    <!-- ==== ÁREA PRINCIPAL ==== -->
    <div class="editor-container">

        <!-- TOPO -->
        <div class="top-bar">
            <div class="top-bar">
                <span>
                    <img class="vozCode_Logo2" src="Imagens/vozCode_logo2.png" alt="Logo">
                </span>
            </div>
        </div>

        <!-- EDITOR -->
        <div class="editor-wrapper">

            <div class="line-numbers" id="lineNumbers"></div>

            <form asp-action="AnalisarCodigo" asp-controller="Execusao" class="editor-area" id="analisarCodigo">
                <div id="highlightLine"></div>

                <textarea name="codigo" id="codeInput" class="editor-input"
                    placeholder="Digite seu código aqui...">@TempData["Codigo"]</textarea>

            </form>

        </div>

    </div>

</div>

<style>
    /* ===== RESET ===== */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
    }

    html,
    body {
        height: 100%;
        background: #0d1b2a;
    }

    /* ===== CONTAINER GERAL ===== */
    .ide-container {
        display: flex;
        width: 100vw;
        height: 100vh;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
        width: 60vh;
        background: #1b263b;
        border-right: 1px solid #324766;
        padding: 20px;
        color: #e0e1dd;
        display: flex;
        flex-direction: column;
    }

    .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .sidebar-content p {
        flex: 1;
        overflow-y: auto;
        font-size: 12px;
        color: #c8d0e0;
        margin-top: 30px;
        line-height: 1.6;
        box-shadow: 0 1px 0 rgba(16, 24, 40, 0.04);
        word-wrap: break-word;
    }

    /* ===== ÁREA DO EDITOR ===== */
    .editor-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        /* fixa a altura */
        overflow: hidden;
        /* impede que o conteúdo empurre a tela */
    }

    /* Barra superior */
    .top-bar {
        height: 49px;
        background: #16213e;
        border-bottom: 1px solid #33415c;
        display: flex;
        align-items: center;
        padding: 0 20px;
        color: #fff;
    }

    /* Wrapper do editor */
    .editor-wrapper {
        flex: 1;
        display: flex;
        height: calc(100% - 50px);
        /* editor ocupa tudo abaixo da top-bar */
        overflow: hidden;
        /* IMPEDIR QUE O EDITOR DESÇA */
        background: #0b121e;
    }

    /* Números de linha */
    .line-numbers {
        width: 55px;
        padding: 15px 10px;
        background: #0d1625;
        border-right: 1px solid #1e2d4d;
        text-align: right;
        font-family: Consolas, monospace;
        font-size: 16px;
        color: #415a77;
        user-select: none;
        overflow: hidden;
        line-height: 1.6em;
    }

    /* Área que contém textarea + highlight */
    .editor-area {
        position: relative;
        flex: 1;
    }

    /* Textarea do editor */
    .editor-input {
        width: 100%;
        height: 100%;
        /* fixa o campo do editor */
        padding: 15px;
        background: #0b121e;
        color: #e0e1dd;
        font-size: 16px;
        font-family: Consolas, monospace;
        line-height: 1.6em;
        border: none;
        outline: none;
        resize: none;
        overflow-y: auto;
        /* SCROLL INTERNO – nunca cresce */
        white-space: pre;
        position: relative;
        z-index: 2;
    }

    .vozCode_Logo2 {
        display: block;
        height: 150px;
        width: auto;
        gap: 15px;
    }

    .bottom-ide {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
    }

    .bottom-analisar {
        background: #080710;
        color: #ffffff;
        padding: 10px 18px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        cursor: pointer;
        transition: 0.25s ease-in-out;
        font-weight: 500;
    }

    .bottom-analisar:hover {
        background: #0e0f1c;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    .bottom-analisar:active {
        transform: translateY(0px);
        box-shadow: none;
    }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar {
        width: 10px;
        /* largura total */
    }

    ::-webkit-scrollbar-track {
        background: transparent;
        /* trilha invisível */
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(121, 121, 121, 0.4);
        /* thumb cinza translúcido */
        border-radius: 10px;
        border: 2px solid transparent;
        /* espaço interno para deixar mais fina */
        background-clip: padding-box;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: rgba(140, 140, 140, 0.55);
        /* efeito hover */
    }

    ::-webkit-scrollbar-corner {
        background: transparent;
    }
</style>

<script>
    window.onbeforeunload = function () {
        // Código aqui
        speechSynthesis.cancel();
    };

    const textarea = document.getElementById("codeInput");
    const lineNumbers = document.getElementById("lineNumbers");
    const highlightLine = document.getElementById("highlightLine");

    /* Atualiza números de linha */
    function updateLineNumbers() {
        const totalLines = textarea.value.split("\n").length;
        let html = "";

        for (let i = 1; i <= totalLines; i++) {
            html += i + "<br>";
        }

        lineNumbers.innerHTML = html;
    }

    /* Atualiza highlight */
    function updateHighlight() {
        const pos = textarea.selectionStart;
        const text = textarea.value.substr(0, pos);
        const lineIndex = text.split("\n").length - 1;

        const lineHeight = parseFloat(getComputedStyle(textarea).lineHeight);

        highlightLine.style.top = lineIndex * lineHeight - textarea.scrollTop + "px";
    }

    /* Sincroniza scroll */
    textarea.addEventListener("scroll", () => {
        lineNumbers.scrollTop = textarea.scrollTop;
        updateHighlight();
    });

    textarea.addEventListener("input", () => {
        updateLineNumbers();
        updateHighlight();
    });

    textarea.addEventListener("click", updateHighlight);
    textarea.addEventListener("keyup", updateHighlight);


    async function AnalisarCodigo() {
        var codigoUsuario = document.getElementById("codeInput").value;

        document.getElementById("RetornoIa").innerText = "Aguarda o feedback";

        await fetch("/execusao/teste", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json"
            },
            body: JSON.stringify(codigoUsuario)
        })
        .then(response => response.text())
        .then(data => {
            document.getElementById("RetornoIa").innerText = data
        })
        .then(() => {
            lerEditor();
        })
        .catch(error => console.error("Erro:", error));
    }


    @* LENDO O CÓDIGO *@
        function lerEditor() {
            const texto = document.getElementById("RetornoIa").innerText;
            
            if (!texto.trim()) return;

            const fala = new SpeechSynthesisUtterance(texto);
            fala.lang = "pt-BR";   // forçar português
            fala.rate = 1;         // velocidade (0.5 a 2)
            fala.pitch = 1;        // tom da voz
            fala.volume = 1;

            speechSynthesis.cancel();  // para evitar sobreposição
            speechSynthesis.speak(fala);
        }


</script>